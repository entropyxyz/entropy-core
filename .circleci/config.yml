version: 2.1

# UBUNTU_2004_STANDARD_IMAGE and CIRCLECI_2XLARGE_RESOURCE_CLASS are defined
# in https://app.circleci.com/settings/project/github/Entropyxyz/entropy-core/environment-variables

commands:
  install-dependencies-and-checkout:
    steps:
      - install-dependencies
      - checkout
  increase-swap:
    steps:
      - run: sudo swapoff -a
      - run: sudo dd if=/dev/zero of=/swapfile bs=1G count=8
      - run: sudo chmod 0600 /swapfile
      - run: sudo mkswap /swapfile
      - run: sudo swapon /swapfile
      - run: grep Swap /proc/meminfo
  install-dependencies:
    steps:
      - run: sudo apt-get update 
      - run: sudo apt install -y libssl-dev clang libclang-dev
      - run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - run: rustup default stable
      - run: rustup update nightly
      - run: rustup update stable
      - run: rustup target add wasm32-unknown-unknown --toolchain nightly

jobs:
  node-test:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - increase-swap
      - install-dependencies-and-checkout
      - run: pushd node && cargo build --release && cargo test
  node-benchmark:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: pushd node && cargo check --features=runtime-benchmarks --release
      
  crypto-protocol:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/protocol && cargo check
  crypto-signing-client:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/signing-client && cargo check
  crypto-common:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/common && cargo check
   
  linting-node-core:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: SKIP_WASM_BUILD=1 cargo clippy
  linting-crypto-protocol:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/protocol && cargo clippy
  linting-crypto-signing-client:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/signing-client && cargo clippy
  linting-crypto-common:
    machine:
      image: $UBUNTU_2004_STANDARD_IMAGE
      resource_class: $CIRCLECI_2XLARGE_RESOURCE_CLASS
    steps:
      - install-dependencies-and-checkout
      - run: cd crypto/common && cargo clippy

workflows:
  entropy-node:
    jobs:
      - node-test
      - node-benchmark
  entropy-crypto:
    jobs:
      - crypto-protocol
      - crypto-signing-client
      - crypto-common
  entropy-linting:
    jobs:
      - linting-node-core
      - linting-crypto-protocol
      - linting-crypto-signing-client
      - linting-crypto-common
