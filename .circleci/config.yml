version: 2.1

commands:
  install-dependencies:
    steps:
      - run: sudo apt-get update 
      - run: sudo apt install -y libssl-dev clang libclang-dev
      - run: curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
      - run: rustup default stable
      - run: rustup update nightly
      - run: rustup update stable
      - run: rustup target add wasm32-unknown-unknown --toolchain nightly

jobs:
  node-test:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: "2xlarge"
    steps:
      - install-dependencies
      - checkout
      - run: pushd node && cargo build --release && cargo test
  node-benchmark:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: "2xlarge"
    steps:
      - install-dependencies
      - checkout
      - run: pushd node && cargo check --features=runtime-benchmarks --release
  crypto-check-keychen:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: "2xlarge"
    steps:
      - install-dependencies
      - checkout
      - run: cd crypto/centralized-keygen && cargo check 
  crypto-signing-client:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: "2xlarge"
    steps:
      - install-dependencies
      - checkout
      - run: cd crypto/signing-client && cargo check
  crypto-common:
    machine:
      image: "ubuntu-2004:202201-02"
      resource_class: "2xlarge"
    steps:
      - install-dependencies
      - checkout
      - run: cd crypto/common && cargo check
workflows:
  entropy-node:
    jobs:
      - node-test
      - node-benchmark
  entropy-crypto:
    jobs:
      - crypto-check-keygen
      - crypto-signing-client
      - crypto-common
